<!doctype html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#050816">
  <link rel="apple-touch-icon" href="icons/192.png">

  <!-- PERFORMANCE OPTIMIZATION -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="icons/192.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
  <title>NZ â€¢ Dashboard</title>
</head>

<body class="dashboard-page">




  <main class="mobile-layout-container">

    <!-- 1. HEADER CONTEXT (Compact & Calm) -->
    <header class="header-context">
      <div class="brand short">
        <i class="fa-solid fa-heart" style="color: var(--brand-rose)"></i> NZ
      </div>
      <h1 class="header-title-lg">Good Morning</h1>
      <div class="muted-text">Ready to grow together today?</div>
    </header>

    <!-- 2. HIGHLIGHT SECTION (Visual Anchor) -->
    <section class="highlight-section">
      <div class="card card-highlight">
        <div class="section-title"><i class="fa-solid fa-rocket-launch"></i> MISSION STATUS</div>
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
          <div>
            <div class="mission-status"><span class="pulse"></span> ACTIVE</div>
            <div class="muted-text" style="margin-top:4px">Day <span id="t-days">00</span> of Forever</div>
          </div>
          <div style="text-align:right">
            <div class="stat-value" style="font-size:1.5rem">84%</div>
            <div class="muted-text">Week Sync</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 3. TOOLS GRID (2-Column Mobile First) -->
    <section class="tools-section">
      <div class="section-title"><i class="fa-solid fa-grid-2"></i> SYSTEM MODULES</div>

      <div class="tools-grid">
        <!-- Row 1: Core Daily -->
        <a href="/daily-tasks" class="tool-card">
          <i class="fa-solid fa-list-check tool-icon"></i>
          <span class="tool-label">Daily Tasks</span>
        </a>

        <a href="/chat" class="tool-card">
          <i class="fa-solid fa-message-heart tool-icon" style="color:hsl(var(--brand-rose))"></i>
          <span class="tool-label">Chat</span>
        </a>

        <!-- Row 2: Progress -->
        <a href="/goals" class="tool-card">
          <i class="fa-solid fa-bullseye tool-icon"></i>
          <span class="tool-label">Goals</span>
        </a>

        <a href="/monthly-todos" class="tool-card">
          <i class="fa-solid fa-calendar-check tool-icon"></i>
          <span class="tool-label">Habits</span>
        </a>

        <!-- Row 3: Management -->
        <a href="/schedule" class="tool-card">
          <i class="fa-regular fa-calendar-days tool-icon"></i>
          <span class="tool-label">Schedule</span>
        </a>

        <a href="/memories" class="tool-card">
          <i class="fa-solid fa-sparkles tool-icon" style="color:hsl(var(--brand-violet))"></i>
          <span class="tool-label">Memories</span>
        </a>
      </div>
    </section>

    <!-- 4. FLOATING INTERACTION ZONE (Fixed Bottom) -->
    <div class="floating-zone">
      <div class="input-pill-wrapper">
        <input type="text" class="input-pill" placeholder="Quick capture ideas..." readonly
          onclick="window.location.href='/daily-tasks#new'">
        <button class="action-fab">
          <i class="fa-solid fa-plus"></i>
        </button>
      </div>
    </div>

    <div style="height: 100px"></div> <!-- Spacer for scroll -->
  </main>

  <!-- MOBILE BOTTOM NAVIGATION -->
  <nav class="bottom-nav">
    <a href="/" class="nav-item active">
      <i class="fa-solid fa-house"></i>
      <span>Home</span>
    </a>
    <a href="/daily-tasks" class="nav-item">
      <i class="fa-solid fa-list-check"></i>
      <span>Tasks</span>
    </a>
    <a href="/goals" class="nav-item">
      <i class="fa-solid fa-bullseye"></i>
      <span>Goals</span>
    </a>
    <a href="/chat" class="nav-item">
      <i class="fa-solid fa-message-heart"></i>
      <span>Chat</span>
    </a>
    <a href="/menu" class="nav-item"
      onclick="event.preventDefault(); document.querySelector('.modules-grid').scrollIntoView({behavior: 'smooth'})">
      <i class="fa-solid fa-grid-2"></i>
      <span>Menu</span>
    </a>
  </nav>

  <script type="module">
    import { initProtected } from './js/main.js';
    import { get } from './js/api.js';

    document.addEventListener('DOMContentLoaded', async () => {
      initProtected();

      // Load Weekly Stats
      const statsContainer = document.getElementById('weekly-stats');
      try {
        const data = await get('/stats');
        if (data && data.stats) {
          statsContainer.innerHTML = '';
          const max = data.combined || 1;

          data.stats.forEach(s => {
            const user = s.user || 'Unknown';
            const score = Number(s.total_score);
            const percent = Math.round((score / max) * 100);

            const row = document.createElement('div');
            row.className = 'stat-row';
            row.innerHTML = `
              <div class="stat-info">
                <span class="stat-user">${user}</span>
                <span class="stat-value">${score} <span class="muted-text">XP</span></span>
              </div>
              <div class="stat-bar-bg">
                <div class="stat-bar-fill" style="width:0%"></div>
              </div>
            `;
            statsContainer.appendChild(row);

            setTimeout(() => {
              row.querySelector('.stat-bar-fill').style.width = `${percent}%`;
            }, 100);
          });

          if (data.stats.length === 0) {
            statsContainer.innerHTML = '<div class="muted center">No mission status reported.</div>';
          }
        }
      } catch (err) {
        console.error(err);
        statsContainer.innerHTML = '<div class="muted center">Link failed.</div>';
      }

      const moodContainer = document.getElementById('weekly-mood');
      if (moodContainer) {
        try {
          const w = await get('/weekly');
          moodContainer.innerHTML = '';
          if (!w || !w.users || Object.keys(w.users).length === 0) {
            moodContainer.innerHTML = '<div class="muted center">No stability data.</div>';
          } else {
            const users = Object.keys(w.users);
            const emoji = n => ({ 1: 'ðŸ˜«', 2: 'ðŸ˜•', 3: 'ðŸ˜', 4: 'ðŸ™‚', 5: 'ðŸ¤©' }[Math.round(n)] || 'ðŸ˜');
            users.forEach(u => {
              const info = w.users[u];
              const section = document.createElement('div');
              section.className = 'mood-user-section';
              section.innerHTML = `
                <div class="mood-header">
                  <span class="mood-user">${u}</span>
                  <span class="mood-sync">SYNC: ${info.correlation ?? '0'}%</span>
                </div>
                <div class="mood-grid"></div>
              `;
              const grid = section.querySelector('.mood-grid');
              info.per_day.forEach(p => {
                const cell = document.createElement('div');
                cell.className = 'mood-cell';
                const m = p.mood !== null ? emoji(p.mood) : 'â€”';
                cell.innerHTML = `<span>${m}</span>`;
                grid.appendChild(cell);
              });
              moodContainer.appendChild(section);
            });
          }
        } catch (err) {
          console.error(err);
          moodContainer.innerHTML = '<div class="muted center">Sync error.</div>';
        }
      }
    });


  </script>
</body>

</html>